# Criar um Aplicativo Web para usar um Modelo ML

Nesta liÃ§Ã£o, vocÃª treinarÃ¡ um modelo ML em um conjunto de dados que estÃ¡ fora deste mundo: _Avistamentos de OVNIs no Ãºltimo sÃ©culo_, provenientes do banco de dados do NUFORC.

VocÃª aprenderÃ¡:

- Como "picles" um modelo treinado
- Como usar esse modelo em um aplicativo Flask

Continuaremos a usar notebooks para limpar dados e treinar nosso modelo, mas vocÃª pode levar o processo um passo adiante explorando o uso de um modelo "selvagem", por assim dizer: em um aplicativo Web.

Para fazer isso, vocÃª precisa construir um aplicativo Web usando Flask.

## [Teste de prÃ©-aula](https://white-water-09ec41f0f.azurestaticapps.net/quiz/17/)

## Criando um aplicativo

HÃ¡ vÃ¡rias maneiras de criar aplicativos Web para consumir modelos de aprendizado de mÃ¡quina. Sua arquitetura da Web pode influenciar a maneira como seu modelo Ã© treinado. Imagine que vocÃª estÃ¡ trabalhando em um negÃ³cio onde o grupo de ciÃªncia de dados treinou um modelo que eles querem que vocÃª use em um aplicativo.

### ConsideraÃ§Ãµes

HÃ¡ muitas perguntas que vocÃª precisa fazer:

- **Ã‰ um aplicativo Web ou um aplicativo mÃ³vel?** Se vocÃª estiver criando um aplicativo mÃ³vel ou precisar usar o modelo em um contexto de IoT, poderÃ¡ usar [TensorFlow Lite](https://www.tensorflow.org/lite/) e usar o modelo em um aplicativo Android ou iOS.
- **Onde o modelo residirÃ¡?** Na nuvem ou localmente?
- **Suporte off-line.** O aplicativo precisa trabalhar off-line?
- **Que tecnologia foi usada para treinar o modelo?** A tecnologia escolhida pode influenciar as ferramentas que vocÃª precisa usar.
  
   - **Usando fluxo de Tensor.** Se vocÃª estiver treinando um modelo usando TensorFlow, por exemplo, esse ecossistema oferece a capacidade de converter um modelo TensorFlow para uso em um aplicativo Web usando [TensorFlow.js](https://www.tensorflow.org/js/).
- **Usando o PyTorch.** Se vocÃª estiver criando um modelo usando uma biblioteca como [PyTorch](https://pytorch.org/), terÃ¡ a opÃ§Ã£o de exportÃ¡-lo no formato [ONNX](https://onnx.ai/) (Open Neural Network Exchange) para uso em aplicativos Web JavaScript que podem usar o [Onnx Runtime](https://www.onnxruntime.ai/). Essa opÃ§Ã£o serÃ¡ explorada em uma liÃ§Ã£o futura para um modelo treinado com o Scikit.
- **Usando o Lobe.ai ou o Azure Custom Vision.** Se vocÃª estiver usando um sistema ML SaaS (Software as a Service) como [Lobe.ai](https://lobe.ai/) ou [Azure Custom Vision](https://azure.microsoft.com/services/cognitive-services/custom-vision-service/?WT.mc_id=academy-15963-cxa) para treinar um modelo, esse tipo de software fornece maneiras de exportar o modelo para vÃ¡rias plataformas, incluindo a criaÃ§Ã£o de uma API sob medida ser consultado na nuvem pelo aplicativo online.


VocÃª tambÃ©m tem a oportunidade de construir um aplicativo web Flask inteiro que seria capaz de treinar o prÃ³prio modelo em um navegador da web. Isso tambÃ©m pode ser feito usando TensorFlow.js em um contexto JavaScript.

Para nossos propÃ³sitos, jÃ¡ que estamos trabalhando com notebooks baseados em Python, vamos explorar as etapas que vocÃª precisa seguir para exportar um modelo treinado de tal notebook para um formato legÃ­vel por um aplicativo web construÃ­do em Python.

## Ferramenta

Para esta tarefa, vocÃª precisa de duas ferramentas: Flask e Pickle, ambos em Python.

O que Ã© [Frasco](https://palletsprojects.com/p/flask/)? Definido como um 'microframework' por seus criadores, o Flask fornece as caracterÃ­sticas bÃ¡sicas de frameworks web usando Python e um motor de modelagem para construir pÃ¡ginas web. DÃª uma olhada em [este mÃ³dulo de aprendizado](https://docs.microsoft.com/learn/modules/python-flask-build-ai-web-app?WT.mc_id=academic-15963-cxa) para praticar a construÃ§Ã£o com o Flask.

âœ… O que Ã© [Pickle](https://docs.python.org/3/library/pickle.html)? Pickle ðŸ¥’ Ã© um mÃ³dulo Python que serializa e desserializa uma estrutura de objeto Python. Ao "pichar" um modelo, vocÃª serializa ou achata sua estrutura para uso na web. Tenha cuidado: o pickle nÃ£o Ã© intrinsecamente seguro, portanto, tenha cuidado se for solicitado a `cancelar o pickle` de um arquivo. Um arquivo em conserto tem o sufixo `.pkl`.

## ExercÃ­cio - limpar seus dados

Nesta liÃ§Ã£o, vocÃª usarÃ¡ dados de 80.000 avistamentos de UFO, coletados pelo [NUFORC](https://nuforc.org) (Centro Nacional de RelatÃ³rios de UFO). Estes dados tÃªm algumas descriÃ§Ãµes interessantes de avistamentos de UFO, por exemplo:

- **DescriÃ§Ã£o de exemplo longo.** "Um homem emerge de um feixe de luz que brilha em um campo gramado Ã  noite e corre em direÃ§Ã£o ao estacionamento da Texas Instruments".
- **Breve descriÃ§Ã£o do exemplo.** "as luzes nos perseguiram".

A planilha [ufos.csv](./data/ufos.csv) inclui colunas sobre `city`, `state` e `country` onde ocorreu o avistamento, `shape` do objeto e sua `latitude` e `longitude`.

No espaÃ§o em branco [notebook](notebook.ipynb) incluÃ­do nesta liÃ§Ã£o:

1. importe `pandas`, `matplotlib` e `numpy` como fez nas liÃ§Ãµes anteriores e importe a planilha ufos. VocÃª pode dar uma olhada em um conjunto de dados de amostra:

    ```python
    import pandas as pd
    import numpy as np
    
    ufos = pd.read_csv('./data/ufos.csv')
    ufos.head()
    ```

1.Converta os dados ufos em um pequeno dataframe com tÃ­tulos novos. Verifique os valores exclusivos no campo `PaÃ­s`.

    ```python
    ufos = pd.DataFrame({'Seconds': ufos['duration (seconds)'], 'Country': ufos['country'],'Latitude': ufos['latitude'],'Longitude': ufos['longitude']})
    
    ufos.Country.unique()
    ```

1. Agora, vocÃª pode reduzir a quantidade de dados que precisamos lidar, eliminando quaisquer valores nulos e importando apenas avistamentos entre 1-60 segundos:

    ```python
    ufos.dropna(inplace=True)
    
    ufos = ufos[(ufos['Seconds'] >= 1) & (ufos['Seconds'] <= 60)]
    
    ufos.info()
    ```

1. Importe a biblioteca 'LabelEncoder' do Scikit-learn para converter os valores de texto dos paÃ­ses em um nÃºmero:

  âœ… LabelEncoder codifica os dados em ordem alfabÃ©tica

    ```python
    from sklearn.preprocessing import LabelEncoder
    
    ufos['Country'] = LabelEncoder().fit_transform(ufos['Country'])
    
    ufos.head()
    ```

    Seus dados devem ter esta aparÃªncia:

    ```output
    	Seconds	Country	Latitude	Longitude
    2	20.0	3		53.200000	-2.916667
    3	20.0	4		28.978333	-96.645833
    14	30.0	4		35.823889	-80.253611
    23	60.0	4		45.582778	-122.352222
    24	3.0		3		51.783333	-0.783333
    ```

## ExercÃ­cio - construa seu modelo

Agora vocÃª pode se preparar para treinar um modelo dividindo os dados no grupo de treinamento e teste.

1. Selecione os trÃªs recursos que vocÃª deseja treinar como seu vetor X, e o vetor y serÃ¡ o `PaÃ­s`. VocÃª quer digitar `Segundos`, `Latitude` e `Longitude` e obter um ID de paÃ­s para retornar.

    ```python
    from sklearn.model_selection import train_test_split
    
    Selected_features = ['Seconds','Latitude','Longitude']
    
    X = ufos[Selected_features]
    y = ufos['Country']
    
    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=0)
    ```

1. Treine seu modelo usando regressÃ£o logÃ­stica:

    ```python
    from sklearn.metrics import accuracy_score, classification_report
    from sklearn.linear_model import LogisticRegression
    model = LogisticRegression()
    model.fit(X_train, y_train)
    predictions = model.predict(X_test)
    
    print(classification_report(y_test, predictions))
    print('Predicted labels: ', predictions)
    print('Accuracy: ', accuracy_score(y_test, predictions))
    ```

A precisÃ£o nÃ£o Ã© ruim **(cerca de 95%)**, sem surpresas, jÃ¡ que `PaÃ­s` e `Latitude/Longitude` se correlacionam.

O modelo que vocÃª criou nÃ£o Ã© muito revolucionÃ¡rio, pois vocÃª deve ser capaz de inferir um `PaÃ­s` a partir de sua `Latitude` e `Longitude`, mas Ã© um bom exercÃ­cio para tentar treinar a partir de dados brutos que vocÃª limpou, exportou e, em seguida, usar esse modelo em um aplicativo Web.

## ExercÃ­cio - 'pickle' seu modelo

Agora, Ã© hora de _pickle_ seu modelo! VocÃª pode fazer isso em algumas linhas de cÃ³digo. Uma vez que seja _pickled_, carregue seu modelo em pickles e teste-o em uma matriz de dados de amostra contendo valores para segundos, latitude e longitude,

```python
import pickle
model_filename = 'ufo-model.pkl'
pickle.dump(model, open(model_filename,'wb'))

model = pickle.load(open('ufo-model.pkl','rb'))
print(model.predict([[50,44,-12]]))
```

O modelo retorna **'3'**, que Ã© o cÃ³digo de paÃ­s do Reino Unido. Selvagem! ðŸ‘½

## ExercÃ­cio - criar um aplicativo Flask

Agora vocÃª pode construir um aplicativo Flask para chamar seu modelo e retornar resultados semelhantes, mas de uma forma mais visualmente agradÃ¡vel.

1. Comece criando uma pasta chamada **web-app** ao lado do arquivo _notebook.ipynb_ onde reside seu arquivo _ufo-model.pkl_.

1. Nessa pasta, crie mais trÃªs pastas: **static**, com uma pasta **css** dentro dela e **templates**. Agora vocÃª deve ter os seguintes arquivos e diretÃ³rios:

    ```output
    web-app/
      static/
        css/
      templates/
    notebook.ipynb
    ufo-model.pkl
    ```

    âœ… Consulte a pasta da soluÃ§Ã£o para obter uma exibiÃ§Ã£o do aplicativo concluÃ­do

1. O primeiro arquivo a ser criado na pasta _web-app_ Ã© o arquivo **requirements.txt**. Como _package.json_ em um aplicativo JavaScript, esse arquivo lista as dependÃªncias exigidas pelo aplicativo. Em **requirements.txt** adicione as linhas:

    ```text
    scikit-learn
    pandas
    numpy
    flask
    ```

1. Agora, execute este arquivo navegando para _web-app_:

    ```bash
    cd web-app
    ```

1. Em seu terminal, digite `pip install` para instalar as bibliotecas listadas em _requirements.txt_:

    ```bash
    pip install -r requirements.txt
    ```

1.Agora, vocÃª estÃ¡ pronto para criar mais trÃªs arquivos para concluir o aplicativo:

1. Crie **app.py** na raiz.
2. Crie **index.html** no diretÃ³rio _templates_.
3. Crie **styles.css** no diretÃ³rio _static/css_.

1. Construa o arquivo _styles.css_ com alguns estilos:

    ```css
    body {
    	width: 100%;
    	height: 100%;
    	font-family: 'Helvetica';
    	background: black;
    	color: #fff;
    	text-align: center;
    	letter-spacing: 1.4px;
    	font-size: 30px;
    }
    
    input {
    	min-width: 150px;
    }
    
    .grid {
    	width: 300px;
    	border: 1px solid #2d2d2d;
    	display: grid;
    	justify-content: center;
    	margin: 20px auto;
    }
    
    .box {
    	color: #fff;
    	background: #2d2d2d;
    	padding: 12px;
    	display: inline-block;
    }
    ```

1. Em seguida, crie o arquivo _index.html_:

    ```html
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="UTF-8">
        <title>ðŸ›¸ UFO Appearance Prediction! ðŸ‘½</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
      </head>
    
      <body>
        <div class="grid">
    
          <div class="box">
    
            <p>According to the number of seconds, latitude and longitude, which country is likely to have reported seeing a UFO?</p>
    
            <form action="{{ url_for('predict')}}" method="post">
              <input type="number" name="seconds" placeholder="Seconds" required="required" min="0" max="60" />
              <input type="text" name="latitude" placeholder="Latitude" required="required" />
              <input type="text" name="longitude" placeholder="Longitude" required="required" />
              <button type="submit" class="btn">Predict country where the UFO is seen</button>
            </form>
    
            <p>{{ prediction_text }}</p>
    
          </div>
    
        </div>
    
      </body>
    </html>
    ```

   DÃª uma olhada na modelagem neste arquivo. Observe a sintaxe do 'bigode' ao redor das variÃ¡veis que serÃ£o fornecidas pelo aplicativo, como o texto de previsÃ£o: `{{}}`. HÃ¡ tambÃ©m uma forma que publica uma previsÃ£o da rota `/predict`.

Finalmente, vocÃª estÃ¡ pronto para construir o arquivo python que direciona o consumo do modelo e a exibiÃ§Ã£o de previsÃµes:

1. Em `app.py` adicione:

    ```python
    import numpy as np
    from flask import Flask, request, render_template
    import pickle
    
    app = Flask(__name__)
    
    model = pickle.load(open("./ufo-model.pkl", "rb"))
    
    
    @app.route("/")
    def home():
        return render_template("index.html")
    
    
    @app.route("/predict", methods=["POST"])
    def predict():
    
        int_features = [int(x) for x in request.form.values()]
        final_features = [np.array(int_features)]
        prediction = model.predict(final_features)
    
        output = prediction[0]
    
        countries = ["Australia", "Canada", "Germany", "UK", "US"]
    
        return render_template(
            "index.html", prediction_text="Likely country: {}".format(countries[output])
        )
    
    
    if __name__ == "__main__":
        app.run(debug=True)
    ```

    >Dica: quando vocÃª adiciona [`debug=True`](https://www.askpython.com/python-modules/flask/flask-debug-mode) ao executar o aplicativo Web usando Flask, todas as alteraÃ§Ãµes feitas no aplicativo serÃ£o refletidas imediatamente sem a necessidade de reiniciar o servidor. Cuidado! NÃ£o habilite este modo em um aplicativo de produÃ§Ã£o.

Se vocÃª executar `python app.py` ou `python3 app.py` - seu servidor Web Ã© iniciado localmente e vocÃª pode preencher um formulÃ¡rio curto para obter uma resposta para sua pergunta de gravaÃ§Ã£o sobre onde os OVNIs foram avistados!

Antes de fazer isso, dÃª uma olhada nas partes de `app.py`:

1. Primeiro, as dependÃªncias sÃ£o carregadas e o aplicativo inicia.
1. EntÃ£o, o modelo Ã© importado.
1. EntÃ£o, index.html Ã© renderizado na rota inicial.

Na rota `/predict`, vÃ¡rias coisas acontecem quando o formulÃ¡rio Ã© publicado:

1. As variÃ¡veis de formulÃ¡rio sÃ£o reunidas e convertidas em uma matriz numÃ©rica. Eles sÃ£o entÃ£o enviados para o modelo e uma previsÃ£o Ã© retornada.
2. Os PaÃ­ses que queremos exibir sÃ£o renderizados novamente como texto legÃ­vel de seu cÃ³digo de paÃ­s previsto, e esse valor Ã© enviado de volta para index.html para ser renderizado no modelo.

Usando um modelo desta maneira, com Flask e um modelo em conserva, Ã© relativamente simples. A coisa mais difÃ­cil Ã© entender qual Ã© a forma dos dados que devem ser enviados ao modelo para obter uma previsÃ£o. Tudo depende de como o modelo foi treinado. Este tem trÃªs pontos de dados para serem inseridos a fim de obter uma previsÃ£o.

Em um ambiente profissional, vocÃª pode ver como uma boa comunicaÃ§Ã£o Ã© necessÃ¡ria entre as pessoas que treinam o modelo e aqueles que o consomem em um aplicativo web ou mÃ³vel. No nosso caso, Ã© sÃ³ uma pessoa, vocÃª!

---

## ðŸš€Desafio

Em vez de trabalhar em um notebook e importar o modelo para o aplicativo Flask, vocÃª poderia treinar o modelo dentro do aplicativo Flask! Tente converter seu cÃ³digo Python no notebook, talvez depois que seus dados forem limpos, para treinar o modelo de dentro do aplicativo em uma rota chamada `train`. Quais sÃ£o os prÃ³s e contras de se buscar esse mÃ©todo?

## [Teste pÃ³s-aula](https://white-water-09ec41f0f.azurestaticapps.net/quiz/18/)

## AnÃ¡lise e autoestudo

HÃ¡ muitas maneiras de construir um aplicativo Web para consumir modelos ML. FaÃ§a uma lista de maneiras de usar JavaScript ou Python para construir um aplicativo Web para aproveitar o aprendizado de mÃ¡quina. Considere a arquitetura: o modelo deve permanecer no aplicativo ou viver na nuvem? Se o Ãºltimo, como vocÃª acessaria? Desenhe um modelo arquitetÃ´nico para uma soluÃ§Ã£o web ML aplicada.

## AtribuiÃ§Ã£o

[Tente um modelo diferente](assignment.md)
